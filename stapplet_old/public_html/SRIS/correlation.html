<!DOCTYPE HTML>
<HTML>
    <HEAD>
    <META NAME="author" CONTENT="Robert Amar">
    <LINK REL="stylesheet" TYPE="text/css" HREF="./master.css">
    <TITLE>SRiS: Correlation and Regression</TITLE>
    <SCRIPT SRC="./prefs_format.js"></SCRIPT>
    <SCRIPT SRC="./results_storage.js"></SCRIPT>
    <SCRIPT SRC="./simple_validate.js"></SCRIPT>
    <SCRIPT SRC="./utility.js"></SCRIPT>
    <SCRIPT SRC="./mean_median_sd.js"></SCRIPT>
    <SCRIPT SRC="./correlation.js"></SCRIPT>
    <SCRIPT SRC="./dotplot.js"></SCRIPT>
    <SCRIPT SRC="./scatterplot.js"></SCRIPT>
    <SCRIPT SRC="./ui_handlers.js"></SCRIPT>
    <SCRIPT><!--
        var bShowLSRL = false;
        var bObsValidated = false;
        
        function toggleLSRL()
        {
            bShowLSRL = !bShowLSRL;
            if (bShowLSRL)
                document.getElementById("btnShowLSRL").value = "Hide LSRL";
            else
                document.getElementById("btnShowLSRL").value = "Show LSRL";
            validateSingleInput();
        }
        
        function subSingleValidate()
        {
            var valid = validateInputFloatArray("txtContext1", "spnContext1Msg", "Context 1") &
                   validateInputFloatArray("txtContext2", "spnContext2Msg", "Context 2");
                   
            // Also need to check and see if the arrays are the same length
            if (valid)
            {
                var arr1 = splitString(document.getElementById("txtContext1").value);
                var arr2 = splitString(document.getElementById("txtContext2").value);
                if (arr1.length != arr2.length)
                {
                    document.getElementById("spnContext1Msg").innerHTML = "Both lists must have the same number of observations.";
                    valid = false;
                }
            }
            return valid;
        }
   
        function validateSingleInput()
        {
            if (subSingleValidate())
            {
                bObsValidated = true;
                refreshScatterplot();
            }
        }
        
        function refreshScatterplot()
        {
            if (bObsValidated)
            {
                var arr1 = splitStringGetArray(document.getElementById("txtContext1").value);
                var arr2 = splitStringGetArray(document.getElementById("txtContext2").value);
                var r = correlation(arr1, arr2);
                var s = LSRLs(arr1, arr2);
                var b0 = LSRLintercept(arr1, arr2);
                var b1 = LSRLslope(arr1, arr2);
                document.getElementById("txtContext1").value = unsplitString(arr1);
                document.getElementById("txtContext2").value = unsplitString(arr2);
                recordInputState("txtContext1");
                recordInputState("txtContext2");
                
                document.getElementById("spnSingleResult").innerHTML = "<B>Observed r: </B>" +
                    formatProportion(r) + "<BR><B>Observed s: </B>" +
                    formatNumber(s) + "<BR><B>Observed slope: </B>" +
                    formatNumber(b1) + "<BR><B>Observed intercept: </B>" +
                    formatNumber(b0);
                    
                var axisLabel1 = document.getElementById("txtAxisLabel1").value.trim();
                var axisLabel2 = document.getElementById("txtAxisLabel2").value.trim();
    
                scatterplot(arr1, arr2, "cnvSinglePlot", 
                    (axisLabel1.length > 0 ? axisLabel1 : null),
                    (axisLabel2.length > 0 ? axisLabel2 : null),
                    bShowLSRL);
                document.getElementById("btnSaveScatterplot").disabled = false;
                document.getElementById("btnShowLSRL").disabled = false;
            }
        }

        function validateMultipleInput()
        {
            var valid = validateInputInt("txtTrials", 0, Number.MAX_VALUE, true, "spnTrialsMsg", "Number of trials", "must be positive.");
            valid = valid & subSingleValidate();

            if (valid)
            {
                var arr1 = splitStringGetArray(document.getElementById("txtContext1").value);
                var arr2 = splitStringGetArray(document.getElementById("txtContext2").value);
                document.getElementById("txtContext1").value = unsplitString(arr1);
                document.getElementById("txtContext2").value = unsplitString(arr2);
                recordInputState("txtContext1");
                recordInputState("txtContext2");
                recordInputState("selType");
                
                var trials = parseInt(document.getElementById("txtTrials").value);
                var results = (document.getElementById("selType").value == "Correlation") ?
                    correlation_simulate_many(arr1, arr2, trials) : LSRLslope_simulate_many(arr1, arr2, trials);
                document.getElementById("spnNumResults").innerHTML =
                    addToStoredResults(results, "txtMultipleResult", formatNumber, "cnvPlot", "Simulated " +
                        document.getElementById("selType").value);
                ui_batchSetProperty(["btnSaveFile", "btnSavePlot", "txtCountBound", "btnCount"], "disabled", false);
                document.getElementById("btnMoreTrials").value = "Add " + trials + " more trials";
                ui_handleCount();
            }
        }

        function resetApplet(bConfirm, bMultOnly, input)
        {
            if (bConfirm)
            {
                if (getStoredResults())
                    if (!confirmStoredResultsReset())
                    {
                        if (input) resetInputState(input.id);
                        return false;
                    }
                else if (!bMultOnly && !document.getElementById("btnSaveScatterplot").disabled)
                {
                    if (!confirm("This will reset the regression.  Are you sure?"))
                    {
                        if (input) resetInputState(input.id);
                        return false;
                    }
                }
            }
                
            resetStoredResults("txtMultipleResult", "cnvPlot");
            ui_batchSetProperty(["btnSaveFile", "btnSavePlot", "txtCountBound", "btnCount"], "disabled", true);
            document.getElementById("btnMoreTrials").value = "Add more trials";
            document.getElementById("spnNumResults").innerHTML = "";
            document.getElementById("txtTrials").value = "";
            ui_clearCount();

            if (!bMultOnly)
            {
                bObsValidated = false;
                document.getElementById("spnSingleResult").innerHTML = "";
                document.getElementById("btnSaveScatterplot").disabled = true;
                document.getElementById("btnShowLSRL").disabled = true;
                var canvas = document.getElementById("cnvSinglePlot");
                var context = canvas.getContext("2d");
                context.clearRect(0, 0, canvas.width, canvas.height);
            }
        }

        function checkSaveCanvas()
        {
            if (!canvasSupported())
            {
                ui_removeElements(["btnSavePlot", "btnSaveScatterplot", "btnShowLSRL", "tdDotplot", "tdScatterplot"]);
                document.getElementById("spnBrowserMsg").innerHTML = "The scatterplot and dotplot features are not supported on this browser.  Please consider using an upgraded browser.";
            }
        }

        ui_setOnLoad(checkSaveCanvas);
    //--></SCRIPT>
    </HEAD>
    <BODY>
        <SPAN CLASS="message" id="spnBrowserMsg"></SPAN>
        <H1>Correlation and Regression</H1>
        <FORM>
            Enter the paired data below separated by commas or spaces, being sure to keep the order of the observations the same in both lists.
            <TABLE>
            <TR>
                <TD CLASS="noborder"></TD>
                <TD CLASS="noborder"><BR><B>Data Values</B></TD>
                <TD CLASS="noborder">(Optional)<BR><B>Axis Label</B></TD>
                <TD CLASS="noborder"></TD>
            </TR>
            <TR>
                <TD CLASS="noborder"><B>Explanatory: </B></TD>
                <TD CLASS="noborder"><INPUT TYPE="text" ID="txtContext1" SIZE="40" ONCHANGE="resetApplet(true, false, this)" ONPASTE="return pasteHandler(this)"></TD>
                <TD CLASS="noborder"><INPUT TYPE="text" ID="txtAxisLabel1" SIZE="10" ONCHANGE="refreshScatterplot()"></TD>
                <TD CLASS="noborder"><SPAN CLASS="message" id="spnContext1Msg"></SPAN></TD>
            </TR><TR>
                <TD CLASS="noborder"><B>Response: </B></TD>
                <TD CLASS="noborder"><INPUT TYPE="text" ID="txtContext2" SIZE="40" ONCHANGE="resetApplet(true, false, this)" ONPASTE="return pasteHandler(this)"></TD>
                <TD CLASS="noborder"><INPUT TYPE="text" ID="txtAxisLabel2" SIZE="10" ONCHANGE="refreshScatterplot()"></TD>
                <TD CLASS="noborder"><SPAN CLASS="message" id="spnContext2Msg"></SPAN></TD>
            </TR>
            </TABLE>
        <DIV ID="divSingle">
                Calculate the observed values of <I>r</I>, <I>s</I>, slope, and y intercept.<BR>
                <INPUT TYPE="button" VALUE="Calculate observed statistics" onClick="validateSingleInput()"><BR>
                <TABLE>
                <TR><TD CLASS="internal"><SPAN ID="spnSingleResult"></SPAN></TD>
                <TD ID="tdScatterplot" CLASS="internal">Scatterplot of data: 
                <INPUT TYPE="button" ID="btnSaveScatterplot" VALUE="Save scatterplot (opens window)" onClick="saveCanvas('cnvSinglePlot', 'Scatterplot')" disabled="true"> 
                <INPUT TYPE="button" ID="btnShowLSRL" VALUE="Show LSRL" onClick="toggleLSRL()" disabled="true"><BR>
                <CANVAS ID="cnvSinglePlot" WIDTH="400" HEIGHT="300"></CANVAS>
                </TD></TR></TABLE>
        </DIV>
        <DIV ID="divMultiple">
            Simulate <INPUT TYPE="text" ID="txtTrials" SIZE="4" onKeyDown="if (event.which == 13 || event.keyCode == 13) validateMultipleInput()"> <SELECT ID="selType" ONCHANGE="resetApplet(true, true, this)">
                <OPTION VALUE="Correlation">correlation(s)</OPTION>
                <OPTION VALUE="Slope">slope(s)</OPTION>
            </SELECT> and get the results, arranged from smallest to largest.<BR>
                The applet will keep track of all of your results until you hit "Reset."<BR>
            <INPUT TYPE="button" ID="btnMoreTrials" VALUE="Add more trials" onClick="validateMultipleInput()">
            <INPUT TYPE="button" ID="btnReset" VALUE="Reset" onClick="resetApplet(false, true)">
            <INPUT TYPE="button" ID="btnSaveFile" VALUE="Save Excel file" onClick="saveCSV('txtMultipleResult','Simulation_' + document.getElementById('selType').value)" disabled="true">
            <INPUT TYPE="button" ID="btnSavePlot" VALUE="Save dotplot" onClick="saveCanvas('cnvPlot','Dotplot_' + document.getElementById('selType').value)" disabled="true"><BR>
            <SPAN id="spnSaveMsg">(Save buttons will open in new tab or window)<BR></SPAN>
            <SPAN CLASS="message" id="spnTrialsMsg"></SPAN><SPAN id="spnMultObs"></SPAN><BR>
        <TABLE>
            <TR><TD CLASS="internal">
            All <SPAN ID="spnNumResults"></SPAN>
            results:<BR>
            <TEXTAREA ID="txtMultipleResult" COLS="10" ROWS="10" READONLY></TEXTAREA><BR>
            </TD><TD ID="tdDotplot" CLASS="internal">
            Dotplot of results:<BR>
            <CANVAS ID="cnvPlot" WIDTH="500" HEIGHT="300"></CANVAS><BR>
            Count the <SELECT ID="selCountType" onChange="ui_handleCount()">
            <OPTION VALUE="number">number</OPTION><OPTION VALUE="percent">percent</OPTION></SELECT>
            of dots <SELECT ID="selCountDir" onChange="ui_handleCount()"><OPTION VALUE="less">less than</OPTION>
            <OPTION VALUE="greater">greater than</OPTION></SELECT>
            or equal to <INPUT TYPE="text" ID="txtCountBound" SIZE="5" onKeyDown="if (event.which == 13 || event.keyCode == 13) ui_handleCount()" disabled="true">
            <INPUT TYPE="button" ID="btnCount" VALUE="Count" onClick="ui_handleCount()" disabled="true">
            <INPUT TYPE="button" ID="btnClearCount" VALUE="Remove count" onClick="ui_clearCount()" disabled="true"><BR>
            <SPAN id="spnCountResult"></SPAN>
            </TD></TR>
        </TABLE>
        </DIV>
        </FORM>
    </BODY>
</HTML>