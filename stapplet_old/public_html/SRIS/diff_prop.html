<!DOCTYPE HTML>
<HTML>
    <HEAD>
    <META NAME="author" CONTENT="Robert Amar">
    <LINK REL="stylesheet" TYPE="text/css" HREF="./master.css">
    <TITLE>SRiS: Difference in Proportions</TITLE>
    <SCRIPT SRC="./prefs_format.js"></SCRIPT>
    <SCRIPT SRC="./results_storage.js"></SCRIPT>
    <SCRIPT SRC="./simple_validate.js"></SCRIPT>
    <SCRIPT SRC="./utility.js"></SCRIPT>
    <SCRIPT SRC="./prop.js"></SCRIPT>
    <SCRIPT SRC="./dotplot.js"></SCRIPT>
    <SCRIPT SRC="./ui_handlers.js"></SCRIPT>
    <SCRIPT><!--
        function subSingleValidate()
        {
            var valid = validateInputInt("txtX1", 0, Number.MAX_VALUE, false, "spnX1Msg", "Successes in Context 1", "must be non-negative.") &
                validateInputInt("txtN1", 0, Number.MAX_VALUE, true, "spnN1Msg", "Attempts in Context 1", "must be positive.") &
                validateInputInt("txtX2", 0, Number.MAX_VALUE, false, "spnX2Msg", "Successes in Context 2", "must be non-negative.") &
                validateInputInt("txtN1", 0, Number.MAX_VALUE, true, "spnN2Msg", "Attempts in Context 2", "must be positive.");

            // Additional validation since the successes must also make sense in context
            if (valid)
            {
                var x1 = parseInt(document.getElementById("txtX1").value);
                var n1 = parseInt(document.getElementById("txtN1").value);
                var x2 = parseInt(document.getElementById("txtX2").value);
                var n2 = parseInt(document.getElementById("txtN2").value);

                if (x1 > n1)
                {
                    document.getElementById("spnX1Msg").innerHTML = "Cannot have more successes than trials in Context 1.<BR>";
                    valid = false;
                }
                if (x2 > n2)
                {
                    document.getElementById("spnX2Msg").innerHTML = "Cannot have more successes than trials in Context 2.";
                    valid = false;
                }
            }
            return valid;
        }
   
        function validateSingleInput()
        {
            if (subSingleValidate())
            {
                var x1 = parseInt(document.getElementById("txtX1").value);
                var n1 = parseInt(document.getElementById("txtN1").value);
                var x2 = parseInt(document.getElementById("txtX2").value);
                var n2 = parseInt(document.getElementById("txtN2").value);
                recordInputStates(["txtX1", "txtN1", "txtX2", "txtN2"]);

                document.getElementById("spnSingleResult").innerHTML = "<B>Context 1 Observed Proportion of Successes: </B>" +
                    formatProportion(x1 / n1) + "<BR><B>Context 2 Observed Proportion of Successes: </B>" +
                    formatProportion(x2 / n2) + "<BR><B>Observed difference: </B>" + formatProportion(x1 / n1 - x2 / n2);
            }
        }

        function validateMultipleInput()
        {
            var valid = validateInputInt("txtTrials", 0, Number.MAX_VALUE, true, "spnTrialsMsg", "Number of trials", "must be positive.");
            valid = valid & subSingleValidate();

            if (valid)
            {
                var x1 = parseInt(document.getElementById("txtX1").value);
                var n1 = parseInt(document.getElementById("txtN1").value);
                var x2 = parseInt(document.getElementById("txtX2").value);
                var n2 = parseInt(document.getElementById("txtN2").value);
                recordInputStates(["txtX1", "txtN1", "txtX2", "txtN2"]);
                
                var trials = parseInt(document.getElementById("txtTrials").value);
                document.getElementById("spnNumResults").innerHTML =
                    addToStoredResults(diff_two_prop_simulate_many(x1, n1, x2, n2, trials), "txtMultipleResult", formatProportion, "cnvPlot", "Simulated Difference in Proportions");
                document.getElementById("spnMultObs").innerHTML = "<B>Observed difference: </B>" + formatProportion(x1 / n1 - x2 / n2);
                ui_batchSetProperty(["btnSaveFile", "btnSavePlot", "txtCountBound", "btnCount"], "disabled", false);
                document.getElementById("btnMoreTrials").value = "Add " + trials + " more trials";
                ui_handleCount();
            }
        }

        function resetApplet(bConfirm, input)
        {
            if (bConfirm)
                if (!confirmStoredResultsReset())
                {
                    if (input) resetInputState(input.id);
                    return false;
                }
                
            resetStoredResults("txtMultipleResult", "cnvPlot");
            ui_batchSetProperty(["btnSaveFile", "btnSavePlot", "txtCountBound", "btnCount"], "disabled", true);
            document.getElementById("btnMoreTrials").value = "Add more trials";
            ui_batchSetProperty(["spnSingleResult", "spnMultObs", "spnNumResults"], "innerHTML", "");
            document.getElementById("txtTrials").value = "";
            ui_clearCount();
        }

        function checkSaveCanvas()
        {
            if (!canvasSupported())
            {
                ui_removeElements(["btnSavePlot", "tdDotplot"]);
                document.getElementById("spnBrowserMsg").innerHTML = "The dotplot feature is not supported on this browser.  Please consider using an upgraded browser.";
            }
        }

        ui_setOnLoad(checkSaveCanvas);
    //--></SCRIPT>
    </HEAD>
    <BODY>
        <SPAN CLASS="message" id="spnBrowserMsg"></SPAN>
        <H1>Difference in Proportions</H1>
        <FORM>
            Enter the observed PERFORMANCEs in each context below.  The test
            statistic will be computed as:<BR>
            (proportion in context 1 - proportion in context 2).
            <TABLE>
                <TR>
                    <TH colspan="2">Context 1</TH>
                    <TH colspan="2">Context 2</TH>
                    <TD CLASS="noborder" rowspan="3"><SPAN CLASS="message" id="spnX1Msg"></SPAN><BR>
                        <SPAN CLASS="message" id="spnN1Msg"></SPAN><BR>
                        <SPAN CLASS="message" id="spnX2Msg"></SPAN><BR>
                        <SPAN CLASS="message" id="spnN2Msg"></SPAN><BR>
                    </TD>
                </TR>
                <TR>
                <TD>Successes:</TD>
                <TD><INPUT TYPE="text" ID="txtX1" SIZE="4" TABINDEX="1" onChange="resetApplet(true, this)"></TD>
                <TD>Successes:</TD>
                <TD><INPUT TYPE="text" ID="txtX2" SIZE="4" TABINDEX="3" onChange="resetApplet(true, this)"></TD>
                </TR>
                <TR>
                <TD>Total attempts:</TD>
                <TD><INPUT TYPE="text" ID="txtN1" SIZE="4" TABINDEX="2" onChange="resetApplet(true, this)"></TD>
                <TD>Total attempts:</TD>
                <TD><INPUT TYPE="text" ID="txtN2" SIZE="4" TABINDEX="4" onChange="resetApplet(true, this)"></TD>
                </TR>
            </TABLE>
        <DIV ID="divSingle">
                Calculate the observed PERFORMANCEs in each context and the difference in these proportions.<BR>
                <INPUT TYPE="button" VALUE="Calculate observed difference in proportions" onClick="validateSingleInput()"><BR>
                <SPAN ID="spnSingleResult"></SPAN>
        </DIV>
        <DIV ID="divMultiple">
            Simulate <INPUT TYPE="text" ID="txtTrials" SIZE="4" onKeyDown="if (event.which == 13 || event.keyCode == 13) validateMultipleInput()"> differences in proportions and get those differences,
                arranged from smallest to largest.<BR>
                The applet will keep track of all of your results until you hit "Reset."<BR>
            <INPUT TYPE="button" ID="btnMoreTrials" VALUE="Add more trials" onClick="validateMultipleInput()">
            <INPUT TYPE="button" ID="btnReset" VALUE="Reset" onClick="resetApplet()">
            <INPUT TYPE="button" ID="btnSaveFile" VALUE="Save Excel file" onClick="saveCSV('txtMultipleResult','Simulation_DiffProp')" disabled="true">
            <INPUT TYPE="button" ID="btnSavePlot" VALUE="Save dotplot" onClick="saveCanvas('cnvPlot','Dotplot_DiffProp')" disabled="true"><BR>
            <SPAN CLASS="message" id="spnTrialsMsg"></SPAN><SPAN id="spnMultObs"></SPAN><BR>
        <TABLE>
            <TR><TD CLASS="internal">
            All <SPAN ID="spnNumResults"></SPAN>
            results:<BR>
            <TEXTAREA ID="txtMultipleResult" COLS="10" ROWS="10" READONLY></TEXTAREA><BR>
            </TD><TD ID="tdDotplot" CLASS="internal">
            Dotplot of results:<BR>
            <CANVAS ID="cnvPlot" WIDTH="500" HEIGHT="300"></CANVAS><BR>
            Count the <SELECT ID="selCountType" onChange="ui_handleCount()">
            <OPTION VALUE="number">number</OPTION><OPTION VALUE="percent">percent</OPTION></SELECT>
            of dots <SELECT ID="selCountDir" onChange="ui_handleCount()"><OPTION VALUE="less">less than</OPTION>
            <OPTION VALUE="greater">greater than</OPTION></SELECT>
            or equal to <INPUT TYPE="text" ID="txtCountBound" SIZE="5" onKeyDown="if (event.which == 13 || event.keyCode == 13) ui_handleCount()" disabled="true">
            <INPUT TYPE="button" ID="btnCount" VALUE="Count" onClick="ui_handleCount()" disabled="true">
            <INPUT TYPE="button" ID="btnClearCount" VALUE="Remove count" onClick="ui_clearCount()" disabled="true"><BR>
            <SPAN id="spnCountResult"></SPAN>
            </TD></TR>
        </TABLE>
        </DIV>
        </FORM>
    </BODY>
</HTML>