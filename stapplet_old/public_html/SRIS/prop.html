<!DOCTYPE HTML>
<HTML>
    <HEAD>
    <META NAME="author" CONTENT="Robert Amar">
    <LINK REL="stylesheet" TYPE="text/css" HREF="./master.css">
    <TITLE>SRiS: Proportion/Number of Successes</TITLE>
    <SCRIPT SRC="./prefs_format.js"></SCRIPT>
    <SCRIPT SRC="./simple_validate.js"></SCRIPT>
    <SCRIPT SRC="./results_storage.js"></SCRIPT>
    <SCRIPT SRC="./utility.js"></SCRIPT>
    <SCRIPT SRC="./prop.js"></SCRIPT>
    <SCRIPT SRC="./dotplot.js"></SCRIPT>
    <SCRIPT SRC="./ui_handlers.js"></SCRIPT>
    <SCRIPT><!--
        function subSingleValidate()
        {
            return validateInputFloat("txtABILITY", 0, 1, false, "spnABILITYMsg", "ABILITY") &
                validateInputInt("txtAttempts", 0, Number.MAX_VALUE, true, "spnAttemptsMsg", "Number of attempts", "must be positive.");
        }
        
        function validateSingleInput()
        {
            if (subSingleValidate())
            {
                var abil = parseFloat(document.getElementById("txtABILITY").value);
                var att = parseInt(document.getElementById("txtAttempts").value);
                var lastResult = one_prop_simulate(abil, att);
                document.getElementById("spnSingleResult").innerHTML = "<B>" + p_currPropPreferenceCapital + " of successes: </B>"
                    + formatProportion(lastResult / att) + "<BR><B>Number of successes: </B>" + lastResult;
                recordInputStates(["txtABILITY", "txtAttempts"]);
            }
        }

        var p_currAttForFormat;
        var p_currTypeForFormat;
        
        function p_fnFormatNumberForDotplot(num)
        {
            if (p_currTypeForFormat == "prop")
                return formatProportion(num / p_currAttForFormat);
            else
                return formatNumber(num);
        }

        function validateMultipleInput()
        {
            var valid = validateInputInt("txtTrials", 0, Number.MAX_VALUE, true, "spnTrialsMsg", "Number of trials", "must be positive.");
            valid = valid & subSingleValidate();

            if (valid)
            {
                var abil = parseFloat(document.getElementById("txtABILITY").value);
                var att = parseInt(document.getElementById("txtAttempts").value);
                p_currAttForFormat = att;
                p_currTypeForFormat = document.getElementById("selResultType").value;
                recordInputStates(["txtABILITY", "txtAttempts", "selResultType"]);

                var trials = parseInt(document.getElementById("txtTrials").value);
                var results = one_prop_simulate_many(abil, att, trials);
                var axisLabel = "Simulated " + ((p_currTypeForFormat == "prop") ? p_currPropPreferenceCapital : "Number") + " of Successes";

                document.getElementById("spnNumResults").innerHTML =
                    addToStoredResults(results, "txtMultipleResult", p_fnFormatNumberForDotplot, "cnvPlot", axisLabel) + " ";
                ui_batchSetProperty(["btnSaveFile", "btnSavePlot", "txtCountBound", "btnCount"], "disabled", false);
                document.getElementById("btnMoreTrials").value = "Add " + trials + " more trials";
                ui_handleCount();
            }
        }
        
        function handleTypeChange()
        {
            // If there are stored results
            if (getStoredResults().length > 0)
            {
                p_currTypeForFormat = document.getElementById("selResultType").value;
                var axisLabel = "Simulated " + ((p_currTypeForFormat == "prop") ? p_currPropPreferenceCapital : "Number") + " of Successes";
    
                // Refresh the dotplot
                var plot = getDotplotForCanvas("cnvPlot")
                if (plot) plot.draw();
                
                // If there is a value in the count, reformat it according to the current formatting desire
                var elt = document.getElementById("txtCountBound");
                if (elt && elt.value.length > 0)
                {
                    // when changing from "prop" -- multiply by the number of results
                    var val = (document.getElementById("selResultType").value == "prop" ?
                        p_fnFormatNumberForDotplot(parseFloat(elt.value)) :
                        Math.round(parseFloat(elt.value) * p_currAttForFormat));
                    ui_setProperty("txtCountBound", "value", val);
                    ui_handleCount();
                }
            }
        }
        
        function resetApplet(bConfirm, input)
        {
            if (bConfirm)
                if (!confirmStoredResultsReset())
                {
                    if (input) resetInputState(input.id);
                    return false;
                }
                
            resetStoredResults("txtMultipleResult", "cnvPlot");
            ui_batchSetProperty(["btnSaveFile", "btnSavePlot", "txtCountBound", "btnCount"], "disabled", true);
            ui_batchSetProperty(["spnSingleResult", "spnNumResults"], "innerHTML", "");
            document.getElementById("btnMoreTrials").value = "Add more trials";
            document.getElementById("txtTrials").value = "";
            ui_clearCount();
        }
        
        var p_currPropPreference;
        var p_currPropPreferenceCapital;
        
        function checkSaveCanvas()
        {
            if (!canvasSupported())
            {
                ui_removeElements(["btnSavePlot", "tdDotplot"]);
                document.getElementById("spnBrowserMsg").innerHTML = "The dotplot feature is not supported on this browser.  Please consider using an upgraded browser.";
            }
            
            // Populate the "proportion" / "percent" visible pieces of the interface
            p_currPropPreference = PREF_PROP_DISPLAY_TYPE;
            p_currPropPreferenceCapital = "P" + p_currPropPreference.slice(1);
            
            document.getElementById("spnPropPrefCap").innerHTML = p_currPropPreferenceCapital;
            var sel = document.getElementById("selResultType");
            sel.options.add(new Option("numbers", "succ"));
            sel.options.add(new Option(p_currPropPreference + "s", "prop"));
        }
        
        ui_setOnLoad(checkSaveCanvas);
//--></SCRIPT>
    </HEAD>
    <BODY>
        <SPAN CLASS="message" id="spnBrowserMsg"></SPAN>
        <H1>Simulating a Single PERFORMANCE (<SPAN ID="spnPropPrefCap"></SPAN>/Number of Successes)</H1>
        <FORM>
            Enter the athlete's ABILITY to be successful as a decimal from 0 to 1:
            <INPUT TYPE="text" ID="txtABILITY" SIZE="5" onChange="resetApplet(true, this)">
            <SPAN CLASS="message" id="spnABILITYMsg"></SPAN>
            <BR>
            Enter the number of attempts:
            <INPUT TYPE="text" ID="txtAttempts" SIZE="4" onChange="resetApplet(true, this)">
            <SPAN CLASS="message" id="spnAttemptsMsg"></SPAN>

        <DIV ID="divSingle">
            Simulate one PERFORMANCE based on the parameters above.<BR>
                <INPUT TYPE="button" VALUE="Simulate one PERFORMANCE" onClick="validateSingleInput()"><BR>
                <SPAN ID="spnSingleResult"></SPAN>
        </DIV>
        <DIV ID="divMultiple">
            Simulate <INPUT TYPE="text" ID="txtTrials" SIZE="4" onKeyDown="if (event.which == 13 || event.keyCode == 13) validateMultipleInput()"> PERFORMANCEs and get the
            <SELECT ID="selResultType" onChange="handleTypeChange()">
            </SELECT> of successes, arranged from smallest to largest.
                The applet will keep track of all of your results until you hit "Reset."<BR>
            <INPUT TYPE="button" ID="btnMoreTrials" VALUE="Add more trials" onClick="validateMultipleInput()">
            <INPUT TYPE="button" ID="btnReset" VALUE="Reset" onClick="resetApplet()">
            <INPUT TYPE="button" ID="btnSaveFile" VALUE="Save Excel file" onClick="saveCSV('txtMultipleResult','Simulation_SingleProp')" disabled="true">
            <INPUT TYPE="button" ID="btnSavePlot" VALUE="Save dotplot" onClick="saveCanvas('cnvPlot','Dotplot_SingleProp')" disabled="true"><BR>
            <SPAN CLASS="message" id="spnTrialsMsg"></SPAN><BR>
        <TABLE>
            <TR><TD CLASS="internal">
            All <SPAN ID="spnNumResults"></SPAN>
            results:<BR>
            <TEXTAREA ID="txtMultipleResult" COLS="10" ROWS="10" READONLY></TEXTAREA><BR>
            </TD><TD ID="tdDotplot" CLASS="internal">
            Dotplot of results:<BR>
            <CANVAS ID="cnvPlot" WIDTH="500" HEIGHT="300"></CANVAS><BR>
            Count the <SELECT ID="selCountType" onChange="ui_handleCount()">
            <OPTION VALUE="number">number</OPTION><OPTION VALUE="percent">percent</OPTION></SELECT>
            of dots <SELECT ID="selCountDir" onChange="ui_handleCount()"><OPTION VALUE="less">less than</OPTION>
            <OPTION VALUE="greater">greater than</OPTION></SELECT>
            or equal to <INPUT TYPE="text" ID="txtCountBound" SIZE="5" onKeyDown="if (event.which == 13 || event.keyCode == 13) ui_handleCount()" disabled="true">
            <INPUT TYPE="button" ID="btnCount" VALUE="Count" onClick="ui_handleCount()" disabled="true">
            <INPUT TYPE="button" ID="btnClearCount" VALUE="Remove count" onClick="ui_clearCount()" disabled="true"><BR>
            <SPAN id="spnCountResult"></SPAN>
            </TD></TR>
        </TABLE>
        </DIV>
        </FORM>
    </BODY>
</HTML>