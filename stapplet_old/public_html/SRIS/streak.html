<!DOCTYPE HTML>
<HTML>
    <HEAD>
    <META NAME="author" CONTENT="Robert Amar">
    <LINK REL="stylesheet" TYPE="text/css" HREF="./master.css">
    <TITLE>SRiS: Streakiness</TITLE>
    <SCRIPT SRC="./prefs_format.js"></SCRIPT>
    <SCRIPT SRC="./simple_validate.js"></SCRIPT>
    <SCRIPT SRC="./results_storage.js"></SCRIPT>
    <SCRIPT SRC="./utility.js"></SCRIPT>
    <SCRIPT SRC="./streak.js"></SCRIPT>
    <SCRIPT SRC="./dotplot.js"></SCRIPT>
    <SCRIPT SRC="./ui_handlers.js"></SCRIPT>
    <SCRIPT><!--
        function cleanStringSFOnly(str)
        {
            return str.replace(/[^sf]+/gm, "");
        }

        function streakInputHandler()
        {
            var str = document.getElementById("txtSeq").value;
            document.getElementById("txtSeq").value = cleanStringSFOnly(str);
        }
        
        function longestStreakValidate()
        {
            if (document.getElementById("txtSeq").value.length > 0)
            {
                document.getElementById("spnSeqMsg").innerHTML = "";
                return true;
            }
            else
            {
                document.getElementById("spnSeqMsg").innerHTML = "Sequence must have at least one valid character.";
                return false;
            }
        }
        
        function countStreakValidate()
        {
            return longestStreakValidate() &
                validateInputInt("txtStreakLength", 0, Number.MAX_VALUE, true, "spnStreakLengthMsg", "Streak length", "must be positive.");
        }
        
        function goSingleLongest()
        {
            if (longestStreakValidate())
            {
                var str = document.getElementById("txtSeq").value;
                document.getElementById("spnSingleLongestResult").innerHTML = "<B>Longest observed streak: </B>" + findLongestStreak(str);
                recordInputState("txtSeq");
            }
        }

        function goSingleCount()
        {
            if (countStreakValidate())
            {
                var len = parseInt(document.getElementById("txtStreakLength").value);
                var str = document.getElementById("txtSeq").value;
                document.getElementById("spnSingleCountResult").innerHTML = "<B>Observed number of streaks of " + len + "+: </B>" + countStreaksOfLength(str, len);
                recordInputState("txtSeq");
                recordInputState("txtStreakLength");
            }
        }

        function validateMultipleInput()
        {
            var valid = validateInputInt("txtTrials", 0, Number.MAX_VALUE, true, "spnTrialsMsg", "Number of trials", "must be positive.");
            var runType = document.getElementById("selType").value;
            var trials = (valid ? parseInt(document.getElementById("txtTrials").value) : 0);
            if (runType == "Longest")
            {
                valid = valid & longestStreakValidate();
                if (valid)
                {
                    var str = document.getElementById("txtSeq").value;
                    var results = simulate_longest_streak_many(str, trials);
                    document.getElementById("spnNumResults").innerHTML =
                        addToStoredResults(results, "txtMultipleResult", null, "cnvPlot", "Longest Simulated Streak");
                }
            }
            else
            {
                valid = valid & countStreakValidate();
                if (valid)
                {
                    var len = parseInt(document.getElementById("txtStreakLength").value);
                    var str = document.getElementById("txtSeq").value;
                    var results = simulate_streaks_of_length_many(str, trials, len);
                    document.getElementById("spnNumResults").innerHTML =
                        addToStoredResults(results, "txtMultipleResult", null, "cnvPlot", "Number of Simulated Streaks of " + len + "+");
                    recordInputState("txtStreakLength");
                }
            }
            
            if (valid)
            {
                recordInputStates(["txtSeq", "selType"]);
                ui_batchSetProperty(["btnSaveFile", "btnSavePlot", "txtCountBound", "btnCount"], "disabled", false);
                document.getElementById("btnMoreTrials").value = "Add " + trials + " more trials";
                ui_handleCount();
            }
        }

        function resetApplet(bConfirm, input)
        {
            if (bConfirm)
                if (!confirmStoredResultsReset())
                {
                    if (input) resetInputState(input.id);
                    return false;
                }
                
            resetStoredResults("txtMultipleResult", "cnvPlot");
            ui_batchSetProperty(["btnSaveFile", "btnSavePlot", "txtCountBound", "btnCount"], "disabled", true);
            document.getElementById("btnMoreTrials").value = "Add more trials";
            ui_batchSetProperty(["spnSingleLongestResult", "spnSingleCountResult", "spnNumResults"], "innerHTML", "");
            document.getElementById("txtTrials").value = "";
            ui_clearCount();
        }
        
        function checkSaveCanvas()
        {
            if (!canvasSupported())
            {
                ui_removeElements(["btnSavePlot", "tdDotplot"]);
                document.getElementById("spnBrowserMsg").innerHTML = "The dotplot feature is not supported on this browser.  Please consider using an upgraded browser.";
            }
        }

        ui_setOnLoad(checkSaveCanvas);
//--></SCRIPT>
    </HEAD>
    <BODY>
        <SPAN CLASS="message" id="spnBrowserMsg"></SPAN>
        <H1>Streak Tests</H1>
        <FORM>
            Enter a sequence of <B><U>s</U></B>uccesses and <B><U>f</U></B>ailures using only the "s" and "f" keys.
            Do not use CAPS LOCK.<BR>
        <TABLE>
        <TR><TD CLASS="noborder">Observed sequence:</TD><TD class="noborder">
            <INPUT TYPE="text" ID="txtSeq" SIZE="40" onKeyUp="streakInputHandler()" onChange="resetApplet(true, this)">
            <SPAN CLASS="message" id="spnSeqMsg"></SPAN></TD></TR>
        </TD></TR>
        </TABLE>
        <TABLE>
        <TR><TD>
            Compute the longest observed streak.<BR>
                <INPUT TYPE="button" VALUE="Find longest streak" onClick="goSingleLongest()"><BR>
                <SPAN ID="spnSingleLongestResult"></SPAN>
        </TD><TD>
            Compute the number of streaks of <INPUT TYPE="text" ID="txtStreakLength" SIZE="3" onChange="resetApplet(true, this)">
            or longer.<BR>
                <INPUT TYPE="button" VALUE="Count streaks of this length" onClick="goSingleCount()">
                <SPAN CLASS="message" id="spnStreakLengthMsg"></SPAN><BR>
                <SPAN ID="spnSingleCountResult"></SPAN>
        </TD></TR>
        </TABLE>
        <DIV ID="divMultiple">
            Examine <INPUT TYPE="text" ID="txtTrials" SIZE="4" onKeyDown="if (event.which == 13 || event.keyCode == 13) validateMultipleInput()"> shuffled sequences for
            <SELECT ID="selType" onChange="resetApplet(true, this)">
                <OPTION VALUE="Longest">the longest streak</OPTION>
                <OPTION VALUE="Count">how many streaks are the above length</OPTION>
            </SELECT> and get the results, arranged from smallest to largest.
                The applet will keep track of all of your results until you hit "Reset."<BR>
            <INPUT TYPE="button" ID="btnMoreTrials" VALUE="Add more trials" onClick="validateMultipleInput()">
            <INPUT TYPE="button" ID="btnReset" VALUE="Reset" onClick="resetApplet()">
            <INPUT TYPE="button" ID="btnSaveFile" VALUE="Save Excel file" onClick="saveCSV('txtMultipleResult','Simulation_Streak' + document.getElementById('selType').value)" disabled="true">
            <INPUT TYPE="button" ID="btnSavePlot" VALUE="Save dotplot" onClick="saveCanvas('cnvPlot','Dotplot_Streak' + document.getElementById('selType').value)" disabled="true"><BR>
            <SPAN CLASS="message" id="spnTrialsMsg"></SPAN><BR>
        <TABLE>
            <TR><TD CLASS="internal">
            All <SPAN ID="spnNumResults"></SPAN>
            results:<BR>
            <TEXTAREA ID="txtMultipleResult" COLS="10" ROWS="10" READONLY></TEXTAREA><BR>
            </TD><TD ID="tdDotplot" CLASS="internal">
            Dotplot of results:<BR>
            <CANVAS ID="cnvPlot" WIDTH="500" HEIGHT="300"></CANVAS><BR>
            Count the <SELECT ID="selCountType" onChange="ui_handleCount()">
            <OPTION VALUE="number">number</OPTION><OPTION VALUE="percent">percent</OPTION></SELECT>
            of dots <SELECT ID="selCountDir" onChange="ui_handleCount()"><OPTION VALUE="less">less than</OPTION>
            <OPTION VALUE="greater">greater than</OPTION></SELECT>
            or equal to <INPUT TYPE="text" ID="txtCountBound" SIZE="5" onKeyDown="if (event.which == 13 || event.keyCode == 13) ui_handleCount()" disabled="true">
            <INPUT TYPE="button" ID="btnCount" VALUE="Count" onClick="ui_handleCount()" disabled="true">
            <INPUT TYPE="button" ID="btnClearCount" VALUE="Remove count" onClick="ui_clearCount()" disabled="true"><BR>
            <SPAN id="spnCountResult"></SPAN>
            </TD></TR>
        </TABLE>
        </DIV>
        </FORM>
    </BODY>
</HTML>